
<?php $__env->startSection('css'); ?>
	<?php echo HTML::style('css/datepicker/datepicker3.css'); ?>
<?php $__env->stopSection(); ?>

<?php $__env->startSection('content'); ?>

<?php if(isset($message)): ?>

<h3><?php echo e($message); ?></h3>

<?php else: ?>

<h1>New User</h1>
<?php echo Form::open(array('url' => route('api.v1.users.store'), 'method' => 'POST', 'role'=>'form')); ?>
	<div class="row">
		<div class="col-sm-4">
			<div class="form-group">
				<?php echo Form::label('username', 'Username'); ?>
				<?php echo Form::text('username', null, array('class'=>'form-control', 'placeholder'=>'Username')); ?>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-sm-4">
			<div class="form-group">
				<?php echo Form::label('password', 'Password'); ?>
				<?php echo Form::password('password', array('class'=>'form-control', 'placeholder'=>'Password')); ?>
			</div>
		</div>
		<div class="col-sm-4">
			<div class="form-group">
				<?php echo Form::label('confirm_password', 'Confirm Password'); ?>
				<?php echo Form::password('confirm_password', array('class'=>'form-control', 'placeholder'=>'Confirm Password')); ?>
			</div>
		</div>
	</div>
	<hr>
	<div class="row">
		<div class="col-sm-4">
			<div class="form-group">
				<?php echo Form::label('first_name', 'First name'); ?>
				<?php echo Form::text('first_name', null, array('class'=>'form-control', 'placeholder'=>'First name')); ?>
			</div>
		</div>
		<div class="col-sm-4">
			<div class="form-group">
				<?php echo Form::label('last_name', 'Last name'); ?>
				<?php echo Form::text('last_name', null, array('class'=>'form-control', 'placeholder'=>'Last name')); ?>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-sm-4">
			<div class="form-group">
				<?php echo Form::label('email', 'Email'); ?>
				<?php echo Form::email('email', null, array('class'=>'form-control', 'placeholder'=>'Email')); ?>
			</div>
		</div>
		<div class="col-sm-4">
			<div class="form-group">
				<?php echo Form::label('gender', 'Gender'); ?>
				<?php echo Form::text('gender', null, array('class'=>'form-control', 'placeholder'=>'Gender')); ?>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-sm-4">
			<div class="form-group">
				<?php echo Form::label('birthday', 'Birthday'); ?>
				<?php echo Form::text('birthday', null, array('class'=>'form-control datepicker', 'placeholder'=>'dd/mm/yyyy')); ?>
			</div>
		</div>
	</div>
	<hr>
	<div class="row">
		<div class="col-sm-4">
			<div class="form-group">
				<?php echo Form::label('parent', 'Parent'); ?>
				<select name="parent_id" class="form-control">
					<option value="">Please select parent</option>
				<?php if($user->hasRole('super_admin')): ?>
					<option value="">no parent</option>
				<?php endif; ?>
				<?php foreach($parents as $parent): ?>
					<option value="<?php echo $parent->id; ?>"><?php echo $parent->username; ?></option>
				<?php endforeach; ?>
				</select>
			</div>
		</div>
		<div class="col-sm-4">
			<div class="form-group">
				<?php echo Form::label('role', 'Role'); ?>
				<select name="role_id" class="form-control">
					<option value="">Please select role</option>
				<?php foreach($roles as $role): ?>
					<option value="<?php echo $role->id; ?>"><?php echo $role->name; ?></option>
				<?php endforeach; ?>
				</select>
			</div>
		</div>
	</div>
	<?php echo Form::button('Save', array('class'=>'btn btn-success', 'type'=>'submit')); ?>
<?php echo Form::close(); ?>

<?php endif; ?>

<?php $__env->stopSection(); ?>

<?php $__env->startSection('js'); ?>
	<?php echo HTML::script('js/jquery/jquery.validate.js'); ?>
	<?php echo HTML::script('js/datepicker/datepicker.js'); ?>
<?php $__env->stopSection(); ?>

<?php $__env->startSection('javascript'); ?>

<script type="text/javascript">
		
	var date_format = 'dd/mm/yyyy';
	var $datepicker = $('.datepicker');

	$datepicker.datepicker({
		autoclose: true,
		todayHighlight: true,
	    format: date_format
	}).on('changeDate', function(e){
		$(this).data('timestamp', Math.floor(e.timeStamp/1e3));
	});

	$('form').on('submit', function()
	{
		return false;
	}).validate({
		submitHandler: function(form){
			$this = $(form);
			$datepicker.val($datepicker.data('timestamp'));
			
			$.ajax({
				url: $this.attr('action'),
				type: 'post',
				dataType: 'json',
				data: $this.serialize(),
				success: function(result)
				{
					console.log(result);
					
					$alert = $('<div/>').addClass('alert').fadeIn('fast').prependTo('form');
					switch(result.header.code)
					{
						case 204:
							$alert.addClass('alert-warning')
								.delay(3000).fadeOut('slow', function() {
									$(this).remove();
								});
						break;

						default:
							$alert.addClass('alert-success')
								.delay(3000).fadeOut('slow', function() {
									$(this).remove();
									window.location.href = "<?php echo route('v1.users.index'); ?>";
								});
					}

					
					$alert.text(result.header.message);
				},
				error: function(e)
				{
					console.log(e);
				}
			});
		},
		rules: {
			username: {
				required: true
			},
			password: {
				required: true
			},
			confirm_password: {
				required: true,
				equalTo: '#password'
			},
		    first_name: {
		      required: true,
		      minlength: 3
		    },
		    last_name: {
		      required: true,
		      minlength: 3
		    },
		    email: {
		      required: true,
		      email: true
		    }
	 	}
	});
</script>

<?php $__env->stopSection(); ?>
<?php echo $__env->make('layouts.master', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>